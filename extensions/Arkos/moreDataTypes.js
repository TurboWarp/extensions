// Name: Advanced Data Structures
// ID: arkosmoredatatypes
// Description: Introducing advanced data structures like objects, with support for nested object!
// By: Arkos <https://scratch.mit.edu/users/lanluzhifeng/>
// License: MIT

(function (Scratch) {
  "use strict";

  const Cast = Scratch.Cast;
  const extensionId = "arkosmoredatatypes";

  const icon =
    "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzAwMjc3NjYzMDI2IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjkwOTkiIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik00MzYgMTI3LjVIMTY4YTQwIDQwIDAgMCAwLTQwIDQwdjEyOGE0MCA0MCAwIDAgMCA0MCA0MGgyNjhhNDAgNDAgMCAwIDAgNDAtNDB2LTEyOGE0MCA0MCAwIDAgMC00MC00MHogbTQyMCAwSDU4OGE0MCA0MCAwIDAgMC00MCA0MHYxMjhhNDAgNDAgMCAwIDAgNDAgNDBoMjY4YTQwIDQwIDAgMCAwIDQwLTQwdi0xMjhhNDAgNDAgMCAwIDAtNDAtNDB6IG0tNDIwIDI4MEgxNjhhNDAgNDAgMCAwIDAtNDAgNDB2MTI4YTQwIDQwIDAgMCAwIDQwIDQwaDI2OGE0MCA0MCAwIDAgMCA0MC00MHYtMTI4YTQwIDQwIDAgMCAwLTQwLTQweiBtNDIwIDAuNUg1ODhhNDAgNDAgMCAwIDAtNDAgNDB2MTI4YTQwIDQwIDAgMCAwIDQwIDQwaDI2OGE0MCA0MCAwIDAgMCA0MC00MFY0NDhhNDAgNDAgMCAwIDAtNDAtNDB6TTQzNiA2ODguNUgxNjhhNDAgNDAgMCAwIDAtNDAgNDB2MTI4YTQwIDQwIDAgMCAwIDQwIDQwaDI2OGE0MCA0MCAwIDAgMCA0MC00MHYtMTI4YTQwIDQwIDAgMCAwLTQwLTQweiBtNDIwIDBINTg4YTQwIDQwIDAgMCAwLTQwIDQwdjEyOGE0MCA0MCAwIDAgMCA0MCA0MGgyNjhhNDAgNDAgMCAwIDAgNDAtNDB2LTEyOGE0MCA0MCAwIDAgMC00MC00MHoiIHAtaWQ9IjkxMDAiIGZpbGw9IiM1MTUxNTEiPjwvcGF0aD48L3N2Zz4=";
  // const cover = 'https://m.ccw.site/user_projects_assets/40d3aa39d5101bd5df854cf3a079fa4a.png';

  /**
   * Objects that can be used safely in Scratch
   * - extends String, so that errors can be avoided when objects are saved in Scratch variables; (Inspired by Nights)
   */
  class SafeObject extends String {
    /**
     * init SafeObject with object or array
     * @param {object} obj object or array
     */
    constructor(obj = {}) {
      super("<SafeObject>");
      this.assign(typeof obj !== "object" ? {} : obj);
    }

    /**
     * assign an object or array to SafeObject
     * @param {any} value
     */
    assign(value) {
      if (typeof value !== "object") {
        throw new Error("Invalid object to assign for SafeObject");
      }
      this.value = SafeObject.getActualObject(value);
      if (!Array.isArray(this.value)) {
        // avoiding prototype pollution
        Object.setPrototypeOf(this.value, null);
      }
    }

    /**
     * parse string to SafeObject
     * @param {string} string Â≠óÁ¨¶‰∏≤
     * @returns {SafeObject} SafeObject
     */
    static parse(string) {
      // return JSON.parse(string, (key, value) => SafeObject.toSafeObject(value));
      return JSON.parse(string);
    }

    /**
     * Â∞Ü SafeObject ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
     * @param {SafeObject} obj SafeObject
     * @returns {string} Â≠óÁ¨¶‰∏≤
     */
    static stringify(obj) {
      // ËÆ∞ÂΩïÂ∑≤Âá∫Áé∞ÂØπË±°ÔºåÈÅøÂÖçÂæ™ÁéØÂºïÁî®
      const seen = [];
      const res = JSON.stringify(obj, (key, value) => {
        const actualObj = SafeObject.getActualObject(value);
        if (typeof actualObj === "object" && actualObj !== null) {
          // Ê£ÄÊµãÂà∞Âæ™ÁéØÂºïÁî®ÔºåÊõøÊç¢‰∏∫ÊèêÁ§∫Â≠óÁ¨¶‰∏≤
          if (seen.includes(actualObj)) {
            return "<Circular Reference>";
          }
          seen.push(actualObj);
        }
        return actualObj;
      });
      return res;
    }

    /**
     * get the actual object for a SafeObject. Otherwise, return the original value
     * @param {object} obj The object to check.
     * @returns {object} The actual object.
     */
    static getActualObject(obj) {
      if (obj instanceof SafeObject) {
        return obj.value;
      }
      return obj;
    }

    /**
     * If it is an object, wrap it in a SafeObject, otherwize return the original value
     * @param {any} value ÂÄº
     * @returns {SafeObject} SafeObject
     */
    static toSafeObject(value) {
      if (
        typeof value === "object" &&
        value !== null &&
        !(value instanceof SafeObject)
      ) {
        return new SafeObject(value);
      }
      return value;
    }

    /**
     * Ê∑±Êã∑Ë¥ùÔºåÊîØÊåÅÂ§ÑÁêÜÂæ™ÁéØÂºïÁî®
     * @param {*} OBJ
     * @param {*} cache
     * @returns
     */
    static deepCopy(OBJ, cache = new Map()) {
      // Ê£ÄÊµãÂæ™ÁéØÂºïÁî®
      if (cache.has(OBJ)) {
        return cache.get(OBJ);
      }
      const obj = SafeObject.getActualObject(OBJ);
      // Â§ÑÁêÜÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã
      if (obj === null || typeof obj !== "object") {
        return obj;
      }
      const safeObj = new SafeObject();
      // Âú®ÁºìÂ≠ò‰∏≠ËÆ∞ÂΩï
      cache.set(OBJ, safeObj);
      let copyObj;
      // Â§ÑÁêÜÊï∞ÁªÑ
      if (Array.isArray(obj)) {
        copyObj = [];
        safeObj.assign(copyObj);
        // ÈÄíÂΩíÂ§çÂà∂Êï∞ÁªÑÂÖÉÁ¥†
        obj.forEach((item, index) => {
          copyObj[index] = SafeObject.deepCopy(item, cache);
        });
        return safeObj;
      }
      // Â§ÑÁêÜÂØπË±°
      copyObj = {};
      safeObj.assign(copyObj);
      // ÈÄíÂΩíÂ§çÂà∂ÂØπË±°Â±ûÊÄß
      Object.keys(obj).forEach((key) => {
        copyObj[key] = SafeObject.deepCopy(obj[key], cache);
      });
      return safeObj;
    }

    /**
     * ËøîÂõû SafeObject Â≠óÁ¨¶‰∏≤Ë°®Á§∫(‰æãÂ¶ÇÔºö"<SafeObject> [1,2,3]")
     * @returns {string} Â≠óÁ¨¶‰∏≤Ë°®Á§∫
     */
    toString() {
      return `<SafeObject> ${SafeObject.stringify(this.value)}`;
    }

    /**
     * ËøîÂõû SafeObject Â≠óÁ¨¶‰∏≤Ë°®Á§∫(‰æãÂ¶ÇÔºö"<SafeObject> [1,2,3]")
     * @returns {string} Â≠óÁ¨¶‰∏≤Ë°®Á§∫
     */
    valueOf() {
      return `<SafeObject> ${SafeObject.stringify(this.value)}`;
    }

    // toJSON() {
    //   return SafeObject.stringify(this.value);
    // }

    /**
     * Â∞ùËØïÂåπÈÖçÂΩ¢Â¶Ç <SafeObject> {"a": 1, "b": 2} ÁöÑÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨‰∏∫SafeObjectÂØπË±°
     * @param {string} string Ë¶ÅËΩ¨Êç¢ÁöÑÂ≠óÁ¨¶‰∏≤
     * @returns {string | SafeObject} ËΩ¨Êç¢ÁªìÊûúÔºàÂ¶ÇÊûúÂ§±Ë¥•ÔºåËøîÂõûÂéüÂÜÖÂÆπÔºâ
     */
    static tryParseSafeObjectString(string) {
      // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂåπÈÖç <SafeObject> {...}
      let match = string.match(/<SafeObject>\s*(.+)$/);
      if (!match) match = string.match(/<SafeObject\s+(.*?)>$/); // ÂåπÈÖç <SafeObject {...}>

      if (match) {
        // ÊèêÂèñÂåπÈÖçÂà∞ÁöÑ JSON Â≠óÁ¨¶‰∏≤
        const jsonString = match[1];

        try {
          // Â∞ùËØïËß£Êûê JSON Â≠óÁ¨¶‰∏≤‰∏∫ÂØπË±°
          const obj = SafeObject.parse(jsonString);
          if (typeof obj !== "object" || obj === null) return string;
          return obj;
        } catch (error) {
          console.error("Error parsing SafeObject:", error);
          return string;
        }
      } else {
        return string;
      }
    }

    /**
     * Convert Scratch variables and lists containing strings like <SafeObject> {...} to SafeObjects.
     * @param {*} runtime runtime ÂØπË±°
     */
    static parseAllVarInProject(runtime) {
      runtime.targets.forEach(({ variables }) => {
        Object.values(variables).forEach((variable) => {
          if (variable.type === "") {
            // ÂèòÈáè
            if (typeof variable.value === "string") {
              variable.value = SafeObject.tryParseSafeObjectString(
                variable.value
              );
            }
          } else if (variable.type === "list") {
            // ÂàóË°®
            const list = variable.value;
            for (let i = 0; i < list.length; i += 1) {
              if (typeof list[i] === "string") {
                list[i] = SafeObject.tryParseSafeObjectString(list[i]);
              }
            }
          }
        });
      });
    }
  }

  class moreDataTypes {
    constructor() {
      this.runtime = Scratch.vm.runtime;

      // // ÊîæÂà∞ runtime ÈáåÔºåÊàñËÆ∏ÂèØ‰ª•ÂíåÂÖ∂‰ªñÊâ©Â±ïËÅîÂä®
      // runtime.SafeObject = SafeObject;

      /** ‰∏¥Êó∂Êï∞ÊçÆ
       * @type {SafeObject}
       */
      this.tempData = new SafeObject();

      /** ÊòØÂê¶ÂêØÁî®ÂµåÂ•óÂäüËÉΩ */
      this.enableNesting = true;

      this.runtime.on("PROJECT_LOADED", () => {
        // SafeObject will be converted to string (like '<SafeObject> {...}') when saved in the project
        // So when the project was loadedÔºåcode below will convert all string like '<SafeObject> {...}' back to SafeObjects.
        SafeObject.parseAllVarInProject(this.runtime);
      });

      const l10n = {
        extensionName: "Advanced Data Structure",
        "name.list": "(list) ",
        "name.object": "(object) ",
        "tag.tempData": "Data",
        "tag.tools": "Common Tools",
        "tag.tempVar": "Temporary Data",
        "tag.complexData": "Complex Data",
        "tag.list": "List Operation",
        "tag.object": "Object Operation",
        "tag.ScratchList": "üê±Scratch List",
        "block.getScratchList": "üóÑÔ∏èScratch list[NAME]",
        "block.setScratchList": "set Scratch list[NAME]toüóÑÔ∏è[OBJ]",
        "block.deleteAllTempData": "delete all data",
        "block.listAllData": "names of exsiting data",
        "block.delTempData": "delete data with name[NAME]",
        "block.ifTempDataExist": "data with name[NAME]exists?",
        "defaultValue.dataName": "data",
        "defaultValue.listName": "my list",
        "defaultValue.objName": "my object",
        "defaultValue.JSON":
          '"name":"Tera","age":12,"friends":["Amy","XiaoMing"]',
        "defaultValue.dataNameOrObj": "name (or input object)",
        "block.setTempData": "data[NAME][OP][VALUE]",
        "menu.op.set": "set to",
        "menu.op.add": "change by",
        "menu.op.insert": "insert before",
        "menu.op.parse": "parse from JSON",
        "menu.op.parse_warning": "parse from JSON",
        "menu.op.shallowCopy": "shallow copy from",
        "menu.op.deepCopy": "deep copy from",
        "block.copyFrom": "üóÑÔ∏è[OP]object[OBJ]",
        "menu.shallow": "shallow copy",
        "menu.deep": "deep copy",
        "block.getTempData": "data[NAME]",
        "menu.getOption.objectAllowed": "value",
        "menu.getOption.json": "JSON",
        "block.getObjFromJson": "üóÑÔ∏èparse string [VALUE] to object",
        "block.newEmptyObjOrArray": "üóÑÔ∏ècreate an [OPTION]",
        "menu.emptyList": "empty list",
        "menu.emptyObj": "empty object",
        "block.getNewList": "üóÑÔ∏è empty list",
        "block.getNewObject": "üóÑÔ∏è empty object",
        "block.typeOf": "type of [VALUE]",
        "block.JSONOf": "convert object[VALUE] to string",
        "block.createOrClearList": "set data [NAME]to an empty list",
        "block.addItemToList": "add [VALUE] to list [NAME_OR_OBJ]",
        "block.mergeList": "üóÑÔ∏è[OP][LIST1][LIST2]",
        "menu.merge": "merge lists",
        "menu.union": "merge lists and remove duplicates",
        "menu.intersection": "common elements between lists",
        "menu.difference": "elements in list1 but not in list2",
        "block.mergeObject":
          "copy üóÑÔ∏èobject[OBJ] properties to object[NAME_OR_OBJ] (overwrite existing properties)",
        "block.opList": "[OP]list[NAME_OR_OBJ]",
        "menu.shuffle": "shuffle",
        "menu.reverse": "reverse",
        "menu.ascSort": "sort (ascending)",
        "menu.descSort": "sort (descending)",
        "menu.removeDuplicates": "remove duplicates from",
        "block.sortListByProp":
          "[OP]list[NAME_OR_OBJ]containing objects by property[PROP]",
        "block.addItemToList2": "[VALUE][OP]list[NAME_OR_OBJ]",
        "menu.addTo": "add to",
        "menu.removeFrom": "remove from",
        "menu.ifNotExistsaddTo": "(if not exists) add to",
        "block.addItemToListAndReturn": "üóÑÔ∏è[VALUE][OP]list[OBJ]",
        "block.createListWithLength": "üóÑÔ∏ècreate a list with [N]x[VALUE]",
        "defaultValue.thing": "thing",
        "block.setItemOfList": "item [IDX] of list [NAME_OR_OBJ][OP][VALUE]",
        "menu.value": "value",
        "block.delItemOfList": "delete item [IDX] of list [NAME_OR_OBJ]",
        "block.getItemOfList": "item [IDX] of list [NAME_OR_OBJ]",
        "block.lengthOfList": "length of list [NAME_OR_OBJ]",
        "block.ifListItemExist": "list [NAME_OR_OBJ] contains [VALUE]?",
        "block.getListItemIdxByItem": "item # of [VALUE] in list [NAME_OR_OBJ]",
        "block.createOrClearObject": "set data [NAME]to an empty object",
        "block.setPropOfObject": "[PROP] of object [NAME_OR_OBJ][OP][VALUE]",
        "block.setPropOfObjectAndReturn": "üóÑÔ∏è[PROP] of object [OBJ][OP][VALUE]",
        "defaultValue.prop": "property",
        "block.delPropOfObject": "delete [PROP] of object [NAME_OR_OBJ]",
        "block.getPropOfObject": "[PROP] of object [NAME_OR_OBJ]",
        "block.getPropOfObjectByIdx":
          "[OPTION] of item [IDX] of object [NAME_OR_OBJ]",
        "menu.conInfo.name": "name",
        "menu.conInfo.value": "content",
        "menu.conInfo.objValue": "content",
        "menu.conInfo.json": "JSON",
        "block.getAllProperties": "get all[OPTION] of object [NAME_OR_OBJ]",
        "menu.keys": "keys",
        "menu.values": "values",
        "menu.entries": "entries",
        "block.sizeOfObject": "size of object [NAME_OR_OBJ]",
        "block.ifObjectPropExist": "object [NAME_OR_OBJ] has [PROP]?",
      };

      this.formatMessage = (id) => {
        return Scratch.translate({
          id,
          default: l10n[id],
          description: id,
        });
      };
    }

    /**
     * Ëé∑Âèñ‚ÄúÊï∞ÊçÆÂêç‚ÄùÂèÇÊï∞
     * @param {'data'|'list'|'obj'} type Á±ªÂûã
     * @returns
     */
    __dataNameOrObjMsg(type) {
      return this.formatMessage("defaultValue.dataName");
    }

    getInfo() {
      return {
        id: extensionId, // ÊãìÂ±ïid
        name: this.formatMessage("extensionName"),
        // docsURI: this.formatMessage('docsURI'),
        color1: "#DA4D16",
        menuIconURI: icon,
        // blockIconURI: icon,
        blocks: [
          // "---" + this.formatMessage("tag.tempData"), // Êï∞ÊçÆ
          "---",
          // Ëé∑ÂèñÊüêÂÜÖÂÆπÁ±ªÂûã
          {
            opcode: "typeOf",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.typeOf"),
            // hideFromPalette: !this.enableNesting,
            arguments: {
              VALUE: {
                type: null,
                // defaultValue: 'foo',
              },
            },
          },
          // Ëé∑ÂèñÊüêÂÜÖÂÆπJSON
          {
            opcode: "JSONOf",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.JSONOf"),
            hideFromPalette: !this.enableNesting,
            arguments: {
              VALUE: {
                type: null,
                // defaultValue: 'foo',
              },
            },
          },
          // Áî±JSONËøîÂõûÂØπË±°
          {
            opcode: "getObjFromJson",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.getObjFromJson"),
            // hideFromPalette: !this.enableNesting,
            arguments: {
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: `{${this.formatMessage("defaultValue.JSON")}}`,
              },
            },
          },
          // Â§çÂà∂ÂØπË±°
          {
            opcode: "copyFrom",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.copyFrom"),
            hideFromPalette: !this.enableNesting,
            arguments: {
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "COPY_MENU",
              },
              OBJ: {
                type: null,
              },
            },
          },
          // ËøîÂõû‰∏Ä‰∏™Á©∫Êï∞ÁªÑ/ÂØπË±°
          {
            opcode: "newEmptyObjOrArray",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.newEmptyObjOrArray"),
            disableMonitor: true,
            hideFromPalette: true, // !this.enableNesting,
            arguments: {
              OPTION: {
                type: Scratch.ArgumentType.STRING,
                // defaultValue: this.formatMessage("defaultValue.JSON"),
                menu: "EMPTY_LIST_OR_OBJ",
              },
            },
          },
          {
            blockType: Scratch.BlockType.LABEL,
            text: this.formatMessage("tag.tempVar"),
          },
          // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
          {
            opcode: "deleteAllTempData",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.deleteAllTempData"),
          },
          // Êï∞ÊçÆÈáè
          {
            opcode: "listAllData",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.listAllData"),
          },
          // Âà†Èô§Êï∞ÊçÆ
          {
            opcode: "delTempData",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.delTempData"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.dataName"),
              },
            },
          },
          // Âà§Êñ≠Êï∞ÊçÆÂ≠òÂú®
          {
            opcode: "ifTempDataExist",
            blockType: Scratch.BlockType.BOOLEAN,
            text: this.formatMessage("block.ifTempDataExist"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.dataName"),
              },
            },
          },
          "---",
          // ËÆæÁΩÆÊï∞ÊçÆ
          {
            opcode: "setTempData",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.setTempData"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.dataName"),
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "DATA_SET_OPTION",
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "100",
              },
            },
          },
          // Ëé∑ÂèñÊï∞ÊçÆ
          {
            opcode: "getTempData",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getTempData"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.dataName"),
              },
              // OPTION: {
              //   type: Scratch.ArgumentType.STRING,
              //   menu: 'DATA_GET_OPTION',
              // },
            },
          },
          // "---" + this.formatMessage("tag.complexData"),
          {
            blockType: Scratch.BlockType.LABEL,
            text: this.formatMessage("tag.list"),
          },
          // ËøîÂõû‰∏Ä‰∏™Á©∫ÂàóË°®
          {
            opcode: "getNewList",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getNewList"),
          },
          // ËøîÂõû‰∏Ä‰∏™N‰∏™NUMÁöÑÂàóË°®
          {
            opcode: "createListWithLength",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.createListWithLength"),
            arguments: {
              N: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 10,
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: "0",
              },
            },
          },
          // ÂêëÂàóË°®Âä†ÂÖ•(ËøîÂõûÂÄºÁâà)
          {
            opcode: "addItemToListAndReturn",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.addItemToListAndReturn"),
            arguments: {
              OBJ: {
                type: null,
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "LIST_ADD_OR_REMOVE",
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          "---",
          // ÂàõÂª∫Á©∫ÂàóË°®
          {
            opcode: "createOrClearList",
            blockType: Scratch.BlockType.COMMAND,
            // hideFromPalette: true, // ÁßØÊú®ÈöêËóèÔºàËøô‰∏™ÁßØÊú®ÁöÑÁî®Ê≥ïÂÆπÊòìËÆ©‰∫∫ËØØ‰ºöÔºâ
            text: this.formatMessage("block.createOrClearList"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
            },
          },
          // ÂêëÂàóË°®Âä†ÂÖ•(ÊóßÁâàÔºåÈöêËóè)
          {
            opcode: "addItemToList",
            blockType: Scratch.BlockType.COMMAND,
            hideFromPalette: true,
            text: this.formatMessage("block.addItemToList"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          // ÂêëÂàóË°®Âä†ÂÖ•
          {
            opcode: "addItemToList2",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.addItemToList2"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "LIST_ADD_OR_REMOVE",
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          // ËÆæÁΩÆÂàóË°®
          {
            opcode: "setItemOfList",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.setItemOfList"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              IDX: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 1,
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "LIST_SET_OPTION",
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          // Âà†Èô§ÂàóË°®XXÈ°π
          {
            opcode: "delItemOfList",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.delItemOfList"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              IDX: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 1,
              },
            },
          },
          "---",
          // Ëé∑ÂèñÂàóË°®XXÈ°π
          {
            opcode: "getItemOfList",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getItemOfList"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              IDX: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 1,
              },
              // OPTION: {
              //   type: Scratch.ArgumentType.STRING,
              //   menu: 'GET_OPTION',
              // },
            },
          },
          // ÂàóË°®ÈïøÂ∫¶
          {
            opcode: "lengthOfList",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.lengthOfList"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
            },
          },
          // ÂàóË°®ÂåÖÂê´xx?
          {
            opcode: "ifListItemExist",
            blockType: Scratch.BlockType.BOOLEAN,
            text: this.formatMessage("block.ifListItemExist"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          // Ëé∑ÂèñÂàóË°®Á¨¨‰∏Ä‰∏™xxÁöÑÁ¥¢Âºï
          {
            opcode: "getListItemIdxByItem",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getListItemIdxByItem"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          "---",
          // ÂêàÂπ∂ÂàóË°®
          {
            opcode: "mergeList",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.mergeList"),
            arguments: {
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "OP_LISTS",
              },
              LIST1: {
                type: null,
              },
              LIST2: {
                type: null,
              },
            },
          },
          // ÂàóË°®ÂèçËΩ¨„ÄÅÊéíÂ∫èÁ≠âÊìç‰Ωú
          {
            opcode: "opList",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.opList"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "LIST_OP",
              },
            },
          },
          // Âê´ÂØπË±°ÁöÑÂàóË°®ÊéíÂ∫è
          {
            opcode: "sortListByProp",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.sortListByProp"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("list"),
              },
              PROP: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.prop"),
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "SORT_ORDER",
              },
            },
          },
          {
            blockType: Scratch.BlockType.LABEL,
            text: this.formatMessage("tag.object"),
          },
          // ËøîÂõû‰∏Ä‰∏™Á©∫ÂØπË±°
          {
            opcode: "getNewObject",
            disableMonitor: true,
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.getNewObject"),
          },
          // ËÆæÁΩÆÂØπË±°(Âπ∂ËøîÂõû)
          {
            opcode: "setPropOfObjectAndReturn",
            blockType: Scratch.BlockType.REPORTER,
            text: this.formatMessage("block.setPropOfObjectAndReturn"),
            arguments: {
              OBJ: {
                type: null,
              },
              PROP: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.prop"),
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "ITEM_SET_OPTION",
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          "---",
          // ÂàõÂª∫Á©∫ÂØπË±°
          {
            opcode: "createOrClearObject",
            blockType: Scratch.BlockType.COMMAND,
            // hideFromPalette: true, // ÁßØÊú®ÈöêËóèÔºàËøô‰∏™ÁßØÊú®ÁöÑÁî®Ê≥ïÂÆπÊòìËÆ©‰∫∫ËØØ‰ºöÔºâ
            text: this.formatMessage("block.createOrClearObject"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
            },
          },
          // ËÆæÁΩÆÂØπË±°
          {
            opcode: "setPropOfObject",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.setPropOfObject"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              PROP: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.prop"),
              },
              OP: {
                type: Scratch.ArgumentType.STRING,
                menu: "ITEM_SET_OPTION",
              },
              VALUE: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.thing"),
              },
            },
          },
          // Âà†Èô§ÂØπË±°Âêç‰∏∫xxÁöÑÂÜÖÂÆπ
          {
            opcode: "delPropOfObject",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.delPropOfObject"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              PROP: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.prop"),
              },
            },
          },
          "---",
          // Ëé∑ÂèñÂØπË±°Âêç‰∏∫XXÁöÑÂÜÖÂÆπ
          {
            opcode: "getPropOfObject",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getPropOfObject"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              PROP: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.prop"),
              },
              // OPTION: {
              //   type: Scratch.ArgumentType.STRING,
              //   menu: 'GET_OPTION',
              // },
            },
          },
          // ÂØπË±°ÈïøÂ∫¶
          {
            opcode: "sizeOfObject",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.sizeOfObject"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
            },
          },
          // ÂØπË±°Â±ûÊÄßÊòØÂê¶Â≠òÂú®
          {
            opcode: "ifObjectPropExist",
            blockType: Scratch.BlockType.BOOLEAN,
            text: this.formatMessage("block.ifObjectPropExist"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              PROP: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.formatMessage("defaultValue.prop"),
              },
            },
          },
          // Ëé∑ÂèñÂØπË±°Á¨¨nÈ°πÁöÑxx
          {
            opcode: "getPropOfObjectByIdx",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getPropOfObjectByIdx"),
            // isDynamic: true,
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              IDX: {
                type: Scratch.ArgumentType.NUMBER,
                defaultValue: 1,
              },
              OPTION: {
                type: Scratch.ArgumentType.STRING,
                menu: "OBJECT_GET_OPTION",
              },
            },
          },
          // Ëé∑ÂèñÂØπË±°ÊâÄÊúâÈîÆ
          {
            opcode: "getAllProperties",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getAllProperties"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              OPTION: {
                type: Scratch.ArgumentType.STRING,
                menu: "KEYS_OR_VALUES_OR_ENTRIES",
              },
            },
          },
          "---",
          // ÂêàÂπ∂ÂØπË±°
          {
            opcode: "mergeObject",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.mergeObject"),
            arguments: {
              NAME_OR_OBJ: {
                type: Scratch.ArgumentType.STRING,
                defaultValue: this.__dataNameOrObjMsg("obj"),
              },
              OBJ: {
                type: null,
              },
            },
          },
          {
            blockType: Scratch.BlockType.LABEL,
            text: this.formatMessage("tag.ScratchList"),
          },
          // Ëé∑ÂèñÂéüÁâàÂàóË°®
          {
            opcode: "getScratchList",
            blockType: Scratch.BlockType.REPORTER,
            disableMonitor: true,
            text: this.formatMessage("block.getScratchList"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                menu: "LIST_MENU",
              },
            },
          },
          // ËÆæÁΩÆÂéüÁâàÂàóË°®
          {
            opcode: "setScratchList",
            blockType: Scratch.BlockType.COMMAND,
            text: this.formatMessage("block.setScratchList"),
            arguments: {
              NAME: {
                type: Scratch.ArgumentType.STRING,
                menu: "LIST_MENU",
              },
              OBJ: {
                type: null,
              },
            },
          },
        ],
        menus: {
          LIST_ADD_OR_REMOVE: [
            {
              text: this.formatMessage("menu.addTo"),
              value: "add",
            },
            {
              text: this.formatMessage("menu.removeFrom"),
              value: "remove",
            },
            {
              text: this.formatMessage("menu.ifNotExistsaddTo"),
              value: "addIfNotExists",
            },
          ],
          LIST_MENU: {
            acceptReporters: true,
            items: "listMenu",
          },
          DATA_SET_OPTION: {
            items: "__dataSetOptionMenu",
          },
          ITEM_SET_OPTION: {
            items: "__itemSetOptionMenu",
          },
          LIST_SET_OPTION: {
            items: "__listSetOptionMenu",
          },
          INSERT_OPTION: {
            items: "__insertOptionMenu",
          },
          DATA_GET_OPTION: {
            items: "__dataGetOptionMenu",
          },
          GET_OPTION: {
            items: "__getOptionMenu",
          },
          OBJECT_GET_OPTION: {
            items: "__objectGetOptionMenu",
          },
          LIST_OP: [
            {
              text: this.formatMessage("menu.shuffle"),
              value: "shuf",
            },
            {
              text: this.formatMessage("menu.reverse"),
              value: "rev",
            },
            {
              text: this.formatMessage("menu.ascSort"),
              value: "asc",
            },
            {
              text: this.formatMessage("menu.descSort"),
              value: "desc",
            },
            {
              text: this.formatMessage("menu.removeDuplicates"),
              value: "dedup",
            },
          ],
          OP_LISTS: [
            {
              text: this.formatMessage("menu.merge"),
              value: "merge",
            },
            {
              text: this.formatMessage("menu.union"),
              value: "union",
            },
            {
              text: this.formatMessage("menu.intersection"),
              value: "intersec",
            },
            {
              text: this.formatMessage("menu.difference"),
              value: "diff",
            },
          ],
          SORT_ORDER: [
            {
              text: this.formatMessage("menu.ascSort"),
              value: "asc",
            },
            {
              text: this.formatMessage("menu.descSort"),
              value: "desc",
            },
          ],
          KEYS_OR_VALUES_OR_ENTRIES: [
            {
              text: this.formatMessage("menu.keys"),
              value: "keys",
            },
            {
              text: this.formatMessage("menu.values"),
              value: "values",
            },
            {
              text: this.formatMessage("menu.entries"),
              value: "entries",
            },
          ],
          COPY_MENU: [
            {
              text: this.formatMessage("menu.shallow"), // Á©∫ÂàóË°®
              value: "shallow",
            },
            {
              text: this.formatMessage("menu.deep"), // Á©∫ÂØπË±°
              value: "deep",
            },
          ],
          EMPTY_LIST_OR_OBJ: [
            {
              text: this.formatMessage("menu.emptyList"), // Á©∫ÂàóË°®
              value: "[]",
            },
            {
              text: this.formatMessage("menu.emptyObj"), // Á©∫ÂØπË±°
              value: "{}",
            },
          ],
        },
      };
    }
    // ******************** ‚ÜìÂä®ÊÄÅËèúÂçï ********************

    /**
     * ScratchÂàóË°®ÁöÑËèúÂçï
     * @returns
     */
    listMenu() {
      const menus = [];
      let { variables } = this.runtime._stageTarget;
      Object.keys(variables).forEach((variable) => {
        if (variables[variable].type === "list") {
          menus.push({
            text: variables[variable].name,
            value: variables[variable].id,
          });
        }
      });
      try {
        variables = this.runtime._editingTarget.variables;
      } catch (e) {
        variables = "error";
      }
      if (
        variables !== "error" &&
        this.runtime._editingTarget !== this.runtime._stageTarget
      ) {
        Object.keys(variables).forEach((variable) => {
          if (variables[variable].type) {
            menus.push({
              text: `[PRIVATE] ${variables[variable].name}`,
              value: variables[variable].id,
            });
          }
        });
      }
      if (menus.length === 0) {
        menus.push({
          text: "-",
          value: "empty",
        });
      }
      return menus;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ÂÜôÊï∞ÊçÆÊìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàËÆæ‰∏∫„ÄÅÂ¢ûÂä†„ÄÅËß£ÊûêJSON„ÄÅÊµÖÊã∑Ë¥ù„ÄÅÊ∑±Êã∑Ë¥ùÔºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __dataSetOptionMenu() {
      const menu = [
        {
          text: this.formatMessage("menu.op.set"), // ËÆæ‰∏∫
          value: "set",
        },
        {
          text: this.formatMessage("menu.op.add"), // Â¢ûÂä†
          value: "add",
        },
        // {
        //   text: this.formatMessage('menu.op.parse'), // Ëß£ÊûêJSON
        //   value: 'parse',
        // },
      ];
      // if (this.enableNesting) {
      //   menu.push(
      //     {
      //       text: this.formatMessage('menu.op.shallowCopy'), // ÊµÖÊã∑Ë¥ù
      //       value: 'shallowCopy',
      //     },
      //     {
      //       text: this.formatMessage('menu.op.deepCopy'), // Ê∑±Êã∑Ë¥ù
      //       value: 'deepCopy',
      //     },
      //   );
      // }
      return menu;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ÂÜôÂàóË°®Êìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàËÆæ‰∏∫„ÄÅÂ¢ûÂä†„ÄÅÂâçÊèíÂÖ•Ôºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __listSetOptionMenu() {
      const menu = [
        {
          text: this.formatMessage("menu.op.set"), // ËÆæ‰∏∫
          value: "set",
        },
        {
          text: this.formatMessage("menu.op.add"), // Â¢ûÂä†
          value: "add",
        },
        {
          text: this.formatMessage("menu.op.insert"), // Â¢ûÂä†
          value: "insert",
        },
      ];
      return menu;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ÂÜôÊï∞ÊçÆÊìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàËÆæ‰∏∫„ÄÅÂ¢ûÂä†„ÄÅËß£ÊûêJSON„ÄÅÊµÖÊã∑Ë¥ù„ÄÅÊ∑±Êã∑Ë¥ùÔºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __itemSetOptionMenu() {
      const menu = [
        {
          text: this.formatMessage("menu.op.set"), // ËÆæ‰∏∫
          value: "set",
        },
        {
          text: this.formatMessage("menu.op.add"), // Â¢ûÂä†
          value: "add",
        },
      ];
      // if (this.enableNesting) {
      //   menu.push(
      //     {
      //       text: this.formatMessage('menu.op.parse_warning'), // Ëß£ÊûêJSON
      //       value: 'parse',
      //     },
      //     {
      //       text: this.formatMessage('menu.op.shallowCopy'), // ÊµÖÊã∑Ë¥ù
      //       value: 'shallowCopy',
      //     },
      //     {
      //       text: this.formatMessage('menu.op.deepCopy'), // Ê∑±Êã∑Ë¥ù
      //       value: 'deepCopy',
      //     },
      //   );
      // }
      return menu;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ÊèíÂÖ•Êï∞ÊçÆÊìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàËÆæ‰∏∫„ÄÅËß£ÊûêJSON„ÄÅÊµÖÊã∑Ë¥ù„ÄÅÊ∑±Êã∑Ë¥ùÔºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __insertOptionMenu() {
      const menu = [
        {
          text: this.formatMessage("menu.value"), // ËÆæ‰∏∫
          value: "set",
        },
      ];
      if (this.enableNesting) {
        menu.push(
          {
            text: this.formatMessage("menu.op.parse_warning"), // Ëß£ÊûêJSON
            value: "parse",
          },
          {
            text: this.formatMessage("menu.op.shallowCopy"), // ÊµÖÊã∑Ë¥ù
            value: "shallowCopy",
          },
          {
            text: this.formatMessage("menu.op.deepCopy"), // Ê∑±Êã∑Ë¥ù
            value: "deepCopy",
          }
        );
      }
      return menu;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ËØªÊï∞ÊçÆÊìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàÂÄº|ËøêË°åËøîÂõûÂØπË±° / ËøîÂõûJSONÔºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __dataGetOptionMenu() {
      const menu = [
        {
          text: this.enableNesting
            ? this.formatMessage("menu.getOption.objectAllowed") // ÂÖÅËÆ∏ËøîÂõûÂØπË±°
            : this.formatMessage("menu.value"), // ÂÄº
          value: "value",
        },
      ];
      if (this.enableNesting) {
        menu.push({
          text: this.formatMessage("menu.getOption.json"), // ËøîÂõûJSON
          value: "json",
        });
      }
      return menu;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ËØªÊï∞ÊçÆÊìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàÂÄº|ËøêË°åËøîÂõûÂØπË±° / ËøîÂõûJSONÔºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __getOptionMenu() {
      const menu = [
        {
          text: this.enableNesting
            ? this.formatMessage("menu.getOption.objectAllowed") // ÂÖÅËÆ∏ËøîÂõûÂØπË±°
            : this.formatMessage("menu.value"), // ÂÄº
          value: "value",
        },
      ];
      if (this.enableNesting) {
        menu.push({
          text: this.formatMessage("menu.getOption.json"), // ËøîÂõûJSON
          value: "json",
        });
      }
      return menu;
    }

    /**
     * ËøîÂõû‰∏Ä‰∏™ËØªÂØπË±°Êìç‰ΩúÁöÑÂä®ÊÄÅËèúÂçïÔºàÂêçÁß∞/ ÂÜÖÂÆπ|ÂÖÅËÆ∏ËøîÂõûÂØπË±° / ËøîÂõûJSONÔºâ
     * @returns {Array} ËèúÂçïÂàóË°®
     */
    __objectGetOptionMenu() {
      const menu = [
        {
          text: this.formatMessage("menu.conInfo.name"), // ÂêçÁß∞
          value: "name",
        },
        {
          text: this.enableNesting
            ? this.formatMessage("menu.conInfo.objValue") // ÂÜÖÂÆπÔºåÂÖÅËÆ∏ËøîÂõûÂØπË±°
            : this.formatMessage("menu.conInfo.value"), // ÂÜÖÂÆπÂÄº
          value: "value",
        },
      ];
      if (this.enableNesting) {
        menu.push({
          text: this.formatMessage("menu.conInfo.json"), // ËøîÂõûJSON
          value: "json",
        });
      }
      return menu;
    }

    // ÂèòÈáèÁßØÊú®

    /**
     * ‰ªªÊÑèÂÜÖÂÆπËΩ¨ScÂÖÅËÆ∏ÁöÑÂÄº(ÂºÄÂêØÂµåÂ•óÊó∂ÂÖÅËÆ∏ËøîÂõûÂØπË±°ÔºåÂê¶ÂàôÂØπË±°ËøîÂõûJSON)
     * @param {*} value
     * @returns {string|number|object}
     */
    anythingToSCArg(value) {
      return SafeObject.toSafeObject(value) ?? "";
      // // SCÈáåËøô‰∏§‰∏™ÂÄºËøîÂõûÁ©∫ÂÜÖÂÆπ
      // if (value === null || value === undefined) return '';
      // // ÂºÄÂêØÂµåÂ•óÊó∂Áõ¥Êé•ËøîÂõû
      // if (this.enableNesting) {
      //   return SafeObject.toSafeObject(value);
      // }

      // if (typeof value === 'object') {
      //   return SafeObject.stringify(value);
      // }
      // return value;
    }

    /**
     * Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
     */
    deleteAllTempData() {
      this.tempData = new SafeObject();
    }

    /**
     * Êï∞ÊçÆÈáè
     * @returns {string}
     */
    listAllData() {
      return Object.keys(this.tempData.value).join(",");
    }

    /**
     * Âà†Èô§Êï∞ÊçÆ
     * @param {*} NAME
     */
    delTempData({ NAME }) {
      delete this.tempData.value[Cast.toString(NAME)];
    }

    /**
     * Âà§Êñ≠Êï∞ÊçÆÂ≠òÂú®
     * @param {*} NAME
     * @returns {boolean}
     */
    ifTempDataExist({ NAME }) {
      return Object.prototype.hasOwnProperty.call(
        this.tempData.value,
        Cast.toString(NAME)
      );
    }

    /**
     * Ê†πÊçÆOPÔºå‰øÆÊîπ‰º†ÂÖ•ÁöÑÂØπË±°/Êï∞ÁªÑ
     * @param {Array | object} data Ë¶Å‰øÆÊîπÁöÑÂØπË±°/Êï∞ÁªÑ
     * @param {number | string} prop Ë¶Å‰øÆÊîπÁöÑÈ°πÁõÆÁ¥¢Âºï
     * @param {string} OP Êìç‰ΩúÔºöset/ add/ parse/ shallowCopy/ deepCopy
     * @param {*} VALUE
     * @returns {boolean} Êìç‰ΩúÊòØÂê¶ÊàêÂäü
     */
    __setDataByOption(data, prop, OP, VALUE) {
      data = SafeObject.getActualObject(data);
      switch (OP) {
        case "set":
          data[prop] = VALUE;
          return true;
        case "add":
          data[prop] = Cast.toNumber(data[prop]) + Cast.toNumber(VALUE);
          return true;
        case "insert": {
          const list = data;
          const idx = prop;
          list.splice(idx, 0, VALUE);
          return true;
        }
        case "parse": {
          try {
            if (typeof VALUE !== "string") return false;
            const obj = SafeObject.parse(VALUE);
            if (typeof obj !== "object" || obj === null) return false;
            data[prop] = obj;
          } catch (e) {
            return false;
          }
          return true;
        }
        case "shallowCopy": {
          const value = SafeObject.getActualObject(VALUE);
          if (typeof value !== "object" || value === null) return false;
          if (Array.isArray(value)) {
            data[prop] = new SafeObject([...value]);
            return true;
          }
          data[prop] = new SafeObject({ ...value });
          return true;
        }
        case "deepCopy":
          if (typeof VALUE !== "object" || VALUE === null) return false;
          try {
            data[prop] = SafeObject.deepCopy(VALUE);
          } catch (e) {
            return false;
          }
          return true;
        default:
          return false;
      }
    }

    /**
     * ËÆæÁΩÆÊï∞ÊçÆ
     * @param {object} args
     * @param {*} args.NAME
     * @param {*} args.OP Êìç‰ΩúÔºöset/ add
     * @param {*} args.VALUE
     */
    setTempData({ NAME, OP, VALUE }) {
      const name = Cast.toString(NAME);
      this.__setDataByOption(this.tempData.value, name, OP, VALUE);
    }

    /**
     * ‰ªéJSONËß£ÊûêÔºåËøîÂõûÂØπË±°
     * @param {*} VALUE
     * @return {* | ''} ËøîÂõûÂØπË±°
     */
    getObjFromJson({ VALUE }) {
      try {
        if (typeof VALUE !== "string") return "";
        const obj = SafeObject.parse(VALUE);
        // if (typeof obj !== "object" || obj === null) return '';
        return SafeObject.toSafeObject(obj);
      } catch (e) {
        return "";
      }
    }

    /**
     * ÂàõÂª∫ÊàñÊ∏ÖÁ©∫ÂàóË°®/ÂØπË±°
     * @param {object} args
     * @param {string} args.OPTION []/{}
     * @return {SafeObject}
     */
    newEmptyObjOrArray({ OPTION }) {
      return OPTION === "[]" ? new SafeObject([]) : new SafeObject();
    }

    /**
     * ÂàõÂª∫Á©∫ÂØπË±°
     * @return {SafeObject}
     */
    getNewObject() {
      return new SafeObject();
    }

    /**
     * ÂàõÂª∫Á©∫ÂàóË°®
     * @return {SafeObject}
     */
    getNewList() {
      return new SafeObject([]);
    }

    /**
     * ÂàõÂª∫ÂåÖÂê´ N ‰∏™ VALUE ÁöÑÂàóË°®
     * @param {object} args
     * @param {*} args.N Êï∞Èáè
     * @param {*} args.VALUE ÂÜÖÂÆπ
     * @return {SafeObject}
     */
    createListWithLength({ N, VALUE }) {
      const n = Cast.toNumber(N);
      let res;
      // ÂØπ‰∫éÂ§çÊùÇÁ±ªÂûãÔºåÊ∑±Êã∑Ë¥ùÂ§çÂà∂
      if (typeof VALUE === "object" && VALUE !== null) {
        res = Array.from({ length: n }, () => SafeObject.deepCopy(VALUE));
      } else {
        // ÊôÆÈÄöÁ±ªÂûã
        res = Array.from({ length: n }, () => VALUE);
      }
      return new SafeObject(res);
    }

    /**
     * Ëé∑ÂèñxxÁöÑÁ±ªÂûã
     * @param {*} VALUE
     * @return {string} Á±ªÂà´
     */
    typeOf({ VALUE }) {
      const value = SafeObject.getActualObject(VALUE);
      if (Array.isArray(value)) return "list";
      return typeof value;
    }

    /**
     * Ëé∑ÂèñxxÁöÑJSON
     * @param {*} VALUE
     * @return {string} JSON
     */
    JSONOf({ VALUE }) {
      if (VALUE === null || VALUE === undefined) return "";
      return SafeObject.stringify(VALUE);
    }

    /**
     * ÊµÖÊã∑Ë¥ù/ÂÆåÂÖ®Êã∑Ë¥ùÂØπË±°
     * @param {object} args
     * @param {string} args.OP Êìç‰Ωú
     * @param {*} args.OBJ Ë¶ÅÊã∑Ë¥ùÁöÑÂØπË±°
     * @return {*} Êã∑Ë¥ùÁªìÊûú
     */
    copyFrom({ OP, OBJ }) {
      if (OBJ === null || OBJ === undefined) return "";
      // ‰∏çÊòØÂØπË±°ÔºåÁõ¥Êé•ËøîÂõûÁªìÊûú
      if (typeof OBJ !== "object") return OBJ;
      // Ê∑±Êã∑Ë¥ù
      if (OP === "deep") {
        try {
          return SafeObject.deepCopy(OBJ);
        } catch (e) {
          return `error: ${e.message}`;
        }
      } else {
        // ÊµÖÊã∑Ë¥ù
        const obj = SafeObject.getActualObject(OBJ);
        if (Array.isArray(obj)) {
          return new SafeObject([...obj]);
        }
        return new SafeObject({ ...obj });
      }
    }

    /**
     * Ê†πÊçÆOPTIONËØªÊï∞ÊçÆ
     * @param {*} data Êï∞ÊçÆ
     * @param {string} OPTION value/ json
     */
    __getDataByOption(data, OPTION) {
      if (OPTION === "json") {
        if (typeof data === "object") data = SafeObject.stringify(data);
        return this.anythingToSCArg(data);
      }
      return this.anythingToSCArg(data);
    }

    /**
     * Ê†πÊçÆÂêçÂ≠óËé∑ÂèñÊï∞ÊçÆ
     * @param {object} args
     * @param {*} args.NAME Êï∞ÊçÆÂêç
     * @param {string} args.OPTION value/ json
     * @returns {*}
     */
    getTempData({ NAME, OPTION }) {
      const data = this.tempData.value[Cast.toString(NAME)];
      return this.__getDataByOption(data, OPTION);
    }

    // /**
    //  * ÂàõÂª∫ÊàñÊ∏ÖÁ©∫ÂàóË°®/ÂØπË±°
    //  * @param {*} NAME Êï∞ÊçÆÂêç
    //  * @param {string} OPTION []/{}
    //  */
    // createOrClearListOrObject({ NAME, OPTION }) {
    //   this.tempData.value[Cast.toString(NAME)] = OPTION === "[]" ? [] : {};
    // }

    /**
     * ÂàõÂª∫ÊàñÊ∏ÖÁ©∫ÂàóË°®
     * @param {object} args
     * @param {*} args.NAME Êï∞ÊçÆÂêç
     */
    createOrClearList({ NAME }) {
      if (typeof NAME === "object") {
        const value = SafeObject.getActualObject(NAME);
        if (Array.isArray(value)) {
          // Ê∏ÖÁ©∫‰º†ÂÖ•ÁöÑÂàóË°®
          value.length = 0;
        }
        return;
      }
      this.tempData.value[Cast.toString(NAME)] = new SafeObject([]);
    }

    /**
     * ÂàõÂª∫ÊàñÊ∏ÖÁ©∫ÂØπË±°
     * @param {*} NAME Êï∞ÊçÆÂêç
     */
    createOrClearObject({ NAME }) {
      if (typeof NAME === "object") {
        const value = SafeObject.getActualObject(NAME);
        if (value !== null && !Array.isArray(value)) {
          // Ê∏ÖÁ©∫‰º†ÂÖ•ÁöÑÂØπË±°
          Object.keys(value).forEach((key) => {
            delete value[key];
          });
        }
        return;
      }
      this.tempData.value[Cast.toString(NAME)] = new SafeObject();
    }

    /**
     * Ê†πÊçÆÊï∞ÊçÆÂêçorÂØπË±°ÔºåËé∑ÂèñÊï∞ÁªÑÂØπË±°
     * @param {*} NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @returns {Array | false} ËøîÂõûÊï∞ÁªÑÂØπË±°Êàñfalse(ËØªÂèñÂ§±Ë¥•)
     */
    __getListByNameOrObj(NAME_OR_OBJ) {
      let list;
      if (typeof NAME_OR_OBJ === "object") {
        list = NAME_OR_OBJ;
      } else {
        list = this.tempData.value[Cast.toString(NAME_OR_OBJ)];
      }
      list = SafeObject.getActualObject(list);
      if (Array.isArray(list)) return list;
      return false;
    }

    /**
     * (ÊóßÁâà)ÂêëÂàóË°®Âä†ÂÖ•
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.VALUE
     */
    addItemToList({ NAME_OR_OBJ, VALUE }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return;
      this.__setDataByOption(list, list.length, "set", VALUE);
    }

    /**
     * ÂêëÂàóË°®Âä†ÂÖ•/ÁßªÂá∫
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {'add'|'remove'|'addIfNotExists'} args.OP Êìç‰Ωú
     * @param {*} args.VALUE
     */
    addItemToList2({ NAME_OR_OBJ, OP, VALUE }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return;
      this.__addOrRemoveFromList(list, OP, VALUE);
    }

    /**
     * ÂêëÂàóË°®Âä†ÂÖ•/ÁßªÂá∫ÔºåÂπ∂ËøîÂõûÂàóË°®
     * @param {object} args
     * @param {*} args.OBJ ‰º†ÂÖ•ÂØπË±°
     * @param {'add'|'remove'|'addIfNotExists'} args.OP Êìç‰Ωú
     * @param {*} args.VALUE
     */
    addItemToListAndReturn({ OBJ, OP, VALUE }) {
      const list = this.__getArray(OBJ);
      if (!list) return OBJ;
      this.__addOrRemoveFromList(list, OP, VALUE);
      return OBJ;
    }

    /**
     * ÂêëÂàóË°®Âä†ÂÖ•/ÁßªÂá∫ÔºåÂπ∂ËøîÂõûÂàóË°®
     * @param {Array} list ‰º†ÂÖ•ÂàóË°®
     * @param {'add'|'remove'|'addIfNotExists'} OP Êìç‰Ωú
     * @param {*} VALUE ÂÜÖÂÆπ
     */
    __addOrRemoveFromList(list, OP, VALUE) {
      switch (OP) {
        case "add":
          list.push(VALUE);
          break;
        case "remove": {
          const index = this.getListItemIdxByItem({ NAME_OR_OBJ: list, VALUE });
          if (index > 0) {
            list.splice(index - 1, 1);
          }
          break;
        }
        case "addIfNotExists":
          if (!this.ifListItemExist({ NAME_OR_OBJ: list, VALUE })) {
            list.push(VALUE);
          }
          break;
        default:
          break;
      }
    }

    /**
     * ËÆæÁΩÆÂàóË°®Á¨¨xÈ°π
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {number} args.IDX Á¨¨xÈ°π
     * @param {string} args.OP Êìç‰ΩúÔºöset/ add/ parse/ shallowCopy/ deepCopy
     * @param {*} args.VALUE
     */
    setItemOfList({ NAME_OR_OBJ, IDX, OP, VALUE }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return;
      const idx = Cast.toNumber(IDX) - 1;
      if (idx < 0 || idx > list.length) return;

      this.__setDataByOption(list, idx, OP, VALUE);
    }

    /**
     * Âà†Èô§ÂàóË°®XXÈ°π
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {number} args.IDX Á¨¨xÈ°π
     */
    delItemOfList({ NAME_OR_OBJ, IDX }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return;

      const idx = Cast.toNumber(IDX) - 1;
      if (idx < 0 || idx > list.length - 1) return;
      list.splice(idx, 1);
    }

    /**
     * Ëé∑ÂèñÂàóË°®XXÈ°π
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {number} args.IDX Á¨¨xÈ°π
     * @param {string} args.OPTION  value/ json
     * @returns {*}
     */
    getItemOfList({ NAME_OR_OBJ, IDX, OPTION }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return "";

      const idx = Cast.toNumber(IDX) - 1;
      if (idx < 0 || idx > list.length - 1) return "";

      return this.__getDataByOption(list[idx], OPTION);
    }

    /**
     * ÂàóË°®ÈïøÂ∫¶
     * @param {*} NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @returns {number} ÈïøÂ∫¶
     */
    lengthOfList({ NAME_OR_OBJ }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return 0;

      return list.length;
    }

    /**
     * ÂàóË°®ÂåÖÂê´xx?
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.VALUE
     * @returns {boolean}
     */
    ifListItemExist({ NAME_OR_OBJ, VALUE }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return false;

      if (list.indexOf(VALUE) >= 0) {
        return true;
      }
      if (typeof VALUE === "object") return false;
      // Try using Scratch comparison operator on each item.
      // (Scratch considers the string '123' equal to the number 123).
      for (let i = 0; i < list.length; i += 1) {
        if (typeof list[i] !== "object" && Cast.compare(list[i], VALUE) === 0) {
          return true;
        }
      }
      return false;
    }

    /**
     * Ëé∑ÂèñÂàóË°®Á¨¨‰∏Ä‰∏™xxÁöÑÁ¥¢Âºï
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.VALUE
     * @returns {number}
     */
    getListItemIdxByItem({ NAME_OR_OBJ, VALUE }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return 0;

      const idx = list.indexOf(VALUE);
      if (idx >= 0) {
        return idx + 1;
      }
      if (typeof VALUE === "object") return 0;

      for (let i = 0; i < list.length; i += 1) {
        if (typeof list[i] !== "object" && Cast.compare(list[i], VALUE) === 0) {
          return i + 1;
        }
      }
      return 0;
    }

    /**
     * ÂêàÂπ∂‰∏§‰∏™LIST
     * @param {object} args
     * @param {'merge'|'union'|'intersec'|'diff'} args.OP Êìç‰Ωú
     * @param {*} args.LIST1 ÂàóË°®1
     * @param {*} args.LIST2 ÂàóË°®2
     */
    mergeList({ OP, LIST1, LIST2 }) {
      const list1 = this.__getArray(LIST1);
      const list2 = this.__getArray(LIST2);
      let res = [];
      if (list1 && list2) {
        switch (OP) {
          case "merge":
            res = list1.concat(list2);
            break;
          // Âπ∂ÈõÜ
          case "union":
            res = [...new Set(list1.concat(list2))];
            break;
          // ‰∫§ÈõÜ
          case "intersec":
            res = list1.filter((element) => list2.includes(element));
            break;
          // Â∑ÆÈõÜ(list1Êúâlist2Ê≤°Êúâ)
          case "diff":
            res = list1.filter((element) => !list2.includes(element));
            break;
          default:
            break;
        }
      }
      return new SafeObject(res);
    }

    /**
     * ÂØπË±°assign
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.OBJ ÂØπË±°
     */
    mergeObject({ NAME_OR_OBJ, OBJ }) {
      const obj2 = this.__getObj(OBJ);
      if (!obj2) return;
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return;
      Object.assign(obj, obj2);
    }

    /**
     * Êìç‰ΩúÂàóË°®
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {'shuf'|'rev'|'asc'|'desc'|'dedup'} args.OP Êìç‰Ωú
     */
    opList({ NAME_OR_OBJ, OP }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return;
      switch (OP) {
        case "shuf":
          list.sort(() => Math.random() - 0.5);
          break;
        case "rev":
          list.reverse();
          break;
        case "asc":
          list.sort((a, b) => Cast.compare(a, b));
          break;
        case "desc":
          list.sort((a, b) => Cast.compare(b, a));
          break;
        case "dedup": {
          // ÂéªÈáçÂàóË°®ÔºàÂú®ÂéüÂàóË°®‰∏äÊìç‰ΩúÔºâ
          const origList = [...list];
          list.length = 0;
          origList.forEach((item) => {
            if (!list.includes(item)) list.push(item);
          });
          break;
        }
        default:
          break;
      }
    }

    /**
     * Ê†πÊçÆÂØπË±°Â±ûÊÄßÊéíÂ∫èÊï∞ÁªÑ
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.PROP Â±ûÊÄßÂêç
     * @param {'asc'|'desc'} args.OP ÊéíÂ∫èÊñπÂºè
     */
    sortListByProp({ NAME_OR_OBJ, PROP, OP }) {
      const list = this.__getListByNameOrObj(NAME_OR_OBJ);
      if (!list) return;
      const prop = Cast.toString(PROP);
      const asc = OP === "asc" ? 1 : -1;
      try {
        list.sort((a, b) => {
          const a1 = SafeObject.getActualObject(a);
          const b1 = SafeObject.getActualObject(b);
          return Cast.compare(a1[prop], b1[prop]) * asc;
        });
      } catch (e) {
        this.logError(e);
      }
    }

    /**
     * ‰ΩøÁî® Gandi ÊéßÂà∂Âè∞ÂºπÂá∫Êä•Èîô‰ø°ÊÅØ
     * @param  {...any} args Êä•Èîô‰ø°ÊÅØ
     */
    logError(...args) {
      if (this.runtime.logSystem) {
        // errorÁöÑÁ∫¢Â≠óÁúã‰∏çÊ∏ÖÔºåËøòÊòØ‰ΩøÁî®warn
        this.runtime.logSystem.warn(`[${this.formatMessage("name")}]`, ...args);
        if (!this.runtime.isPlayerOnly) this.runtime.logSystem.show();
      } else console.error(`${this.formatMessage("extensionName")}: `, ...args);
    }

    /**
     * Ê†πÊçÆÊï∞ÊçÆÂêçorÂØπË±°ÔºåËé∑ÂèñÂØπË±°
     * @param {*} NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @returns {object | false} ËøîÂõûÂØπË±°Êàñfalse(ËØªÂèñÂ§±Ë¥•)
     */
    __getObjByNameOrObj(NAME_OR_OBJ) {
      let obj;
      if (typeof NAME_OR_OBJ === "object") {
        obj = NAME_OR_OBJ;
      } else {
        obj = this.tempData.value[Cast.toString(NAME_OR_OBJ)];
      }
      obj = SafeObject.getActualObject(obj);
      if (typeof obj === "object" && obj !== null && !Array.isArray(obj)) {
        return obj;
      }
      return false;
    }

    /**
     * ËÆæÁΩÆÂØπË±°
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.PROP Â±ûÊÄßÂêç
     * @param {string} args.OP Êìç‰ΩúÔºöset/ add
     * @param {*} args.VALUE
     */
    setPropOfObject({ NAME_OR_OBJ, PROP, OP, VALUE }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return;

      this.__setDataByOption(obj, Cast.toString(PROP), OP, VALUE);
    }

    /**
     * ‰ªé‰º†ÂÖ•ÂÜÖÂÆπËé∑ÂèñÂØπË±°(ÂàóË°®ËøîÂõûnull)
     * @param {*} OBJ ‰º†ÂÖ•ÂÜÖÂÆπ
     * @returns {object | null} ÂØπË±°
     */
    __getObj(OBJ) {
      if (OBJ === null || typeof OBJ !== "object") return null;
      const obj = SafeObject.getActualObject(OBJ);
      if (Array.isArray(obj)) return null;
      return obj;
    }

    /**
     * ‰ªé‰º†ÂÖ•ÂÜÖÂÆπËé∑ÂèñÂàóË°®
     * @param {*} OBJ ‰º†ÂÖ•ÂÜÖÂÆπ
     * @returns {Array | null} ÂàóË°®
     */
    __getArray(OBJ) {
      if (OBJ === null || typeof OBJ !== "object") return null;
      const obj = SafeObject.getActualObject(OBJ);
      if (!Array.isArray(obj)) return null;
      return obj;
    }

    /**
     * ËÆæÁΩÆÂØπË±°
     * @param {object} args
     * @param {*} args.OBJ ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.PROP Â±ûÊÄßÂêç
     * @param {string} args.OP Êìç‰ΩúÔºöset/ add
     * @param {*} args.VALUE
     */
    setPropOfObjectAndReturn({ OBJ, PROP, OP, VALUE }) {
      const obj = this.__getObj(OBJ);
      if (!obj) return OBJ;
      this.__setDataByOption(obj, Cast.toString(PROP), OP, VALUE);
      return OBJ;
    }

    /**
     * Âà†Èô§ÂØπË±°Âêç‰∏∫xxÁöÑÂÜÖÂÆπ
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.PROP Â±ûÊÄßÂêç
     */
    delPropOfObject({ NAME_OR_OBJ, PROP }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return;

      delete obj[Cast.toString(PROP)];
    }

    /**
     * Ëé∑ÂèñÂØπË±°Âêç‰∏∫XXÁöÑÂÜÖÂÆπ
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.PROP Â±ûÊÄßÂêç
     * @param {string} args.OPTION  value/json
     * @returns {*}
     */
    getPropOfObject({ NAME_OR_OBJ, PROP, OPTION }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return "";

      return this.__getDataByOption(obj[Cast.toString(PROP)], OPTION);
    }

    /**
     * Ëé∑ÂèñÂØπË±°Á¨¨nÈ°πÁöÑxx
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {number} args.IDX Á¥¢Âºï
     * @param {string} args.OPTION  name/ value/ json
     * @returns {*}
     */
    getPropOfObjectByIdx({ NAME_OR_OBJ, IDX, OPTION }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return "";

      const key = Object.keys(obj)[Cast.toNumber(IDX) - 1];
      if (key === undefined) return "";
      if (OPTION === "name") return key;

      return this.__getDataByOption(obj[key], OPTION);
    }

    /**
     * Ëé∑ÂèñÂØπË±°keys
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {'keys'|'values'|'entries'} args.OPTION
     * @returns {*}
     */
    getAllProperties({ NAME_OR_OBJ, OPTION }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return SafeObject.toSafeObject([]);

      let res;
      switch (Cast.toString(OPTION)) {
        case "keys":
          res = Object.keys(obj);
          break;
        case "values":
          res = Object.values(obj);
          break;
        case "entries":
          res = Object.entries(obj).map((item) =>
            SafeObject.toSafeObject(item)
          );
          break;
        default:
          res = [];
      }
      return SafeObject.toSafeObject(res);
    }

    /**
     * ÂØπË±°ÈïøÂ∫¶
     * @param {*} NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @returns {number}
     */
    sizeOfObject({ NAME_OR_OBJ }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return 0;
      return Object.keys(obj).length;
    }

    /**
     * ÂØπË±°ÊòØÂê¶ÊúâÊüê‰∏™Â±ûÊÄß
     * @param {object} args
     * @param {*} args.NAME_OR_OBJ Êï∞ÊçÆÂêçÊàñ‰º†ÂÖ•ÂØπË±°
     * @param {*} args.PROP Â±ûÊÄßÂêç
     * @returns {boolean}
     */
    ifObjectPropExist({ NAME_OR_OBJ, PROP }) {
      const obj = this.__getObjByNameOrObj(NAME_OR_OBJ);
      if (!obj) return false;
      return Object.prototype.hasOwnProperty.call(obj, Cast.toString(PROP));
    }

    /**
     * Ëé∑ÂèñÂéüÁâà Scratch ÂéüÁâàÂàóË°®
     * @param {*} NAME ÂàóË°®Âêç
     * @returns {SafeObject | ''}
     */
    getScratchList({ NAME }, util) {
      if (NAME === "empty") return "";
      let list = util.target.lookupVariableById(NAME);
      if (!list) {
        list = util.target.lookupVariableByNameAndType(NAME, "list");
        if (!list) return "";
      }
      return SafeObject.toSafeObject(list.value);
    }

    /**
     * ‰øÆÊîπÂéüÁâà Scratch ÂéüÁâàÂàóË°®
     * @param {object} args
     * @param {*} args.NAME ÂàóË°®Âêç
     * @param {*} args.OBJ Ë¶ÅËÆæ‰∏∫ÁöÑÂØπË±°
     */
    setScratchList({ NAME, OBJ }, util) {
      const obj = SafeObject.getActualObject(OBJ);
      if (!Array.isArray(obj)) {
        return;
      }
      if (NAME === "empty") return;
      let list = util.target.lookupVariableById(NAME);
      if (!list) {
        list = util.target.lookupVariableByNameAndType(NAME, "list");
        if (!list) return;
      }
      list.value = obj;
    }
  }
  Scratch.extensions.register(new moreDataTypes());
})(Scratch);
